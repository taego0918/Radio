<!DOCTYPE html>
<head>
    <title>荼壺電台</title>
    <link rel="stylesheet" type="text/css" href="video.css" />
</head>
    <body>
        <div class="add-song-bg">
            <div class="song-box">
                <input id="song-url" type="text" placeholder="輸入您想播放的youtube網址">
                <button class="send-song">送出</button>
            </div>
        </div>

        <div class="chatroom">
            <div class="add-song">點播</div>
            <div class="top">在線人數:<span class="connect-num">0</span>
                <div class="version">v 1.00</div>
            </div>
            <div class="chats"></div>
            <div class="chats-BG"></div>
            <div class="message">
                <input id="msg" type="text" placeholder="輸入您的訊息" />
                <button id="send" type="button">送出</button>
            </div>
        </div>

        <div id="player"></div>

        <div class="video-data">
            <div id="user"></div>
            <div id="img"></div>
            正在播放<br/>
            <div id="title"></div>
            <div id="author"></div>
            <div class="volume-control">
                <div class = "volume-img" width="20" height="20"> </div>
                <input type="range" id="volume" min="0" max="100">
            </div>
        </div>

        <div id="bg"><div>
        
        <script src="js/socket.io.js"></script>
        <script>
            let socket      = io.connect('http://192.168.1.128:8092', { 'reconnect': true }),
                chats       = document.getElementsByClassName('chats')[0],
                connectNum  = document.getElementsByClassName('connect-num')[0],
                send        = document.getElementById('send'),
                tag         = document.createElement('script'),
                volume      = document.getElementById('volume'),
                title       = document.getElementById('title'),
                author      = document.getElementById('author'),
                img         = document.getElementById('img'),
                bg          = document.getElementById('bg'),
                songUrl     = document.getElementById('song-url'),
                user        = document.getElementById('user'),
                addSong     = document.getElementsByClassName('add-song')[0],
                songBox     = document.getElementsByClassName('song-box')[0],
                addSongBg   = document.getElementsByClassName('add-song-bg')[0],
                sendSong    = document.getElementsByClassName('send-song')[0];

                tag.src = "https://www.youtube.com/iframe_api";
            let firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            let videoData , player , videoId,videoList = [];

            addSong.addEventListener('click',(e)=>{
                addSongBg.style.display = 'block';
            })

            addSongBg.addEventListener('click',(e)=>{
                e.stopPropagation();
                addSongBg.style.display = 'none';
            })

            volume.addEventListener('change',(e)=>{
                player.setVolume(volume.value);
            })
            
            songUrl.addEventListener('click',(e)=>{
                e.stopPropagation();
            })
            songBox.addEventListener('click',(e)=>{
                e.stopPropagation();
            })

            sendSong.addEventListener('click',(e)=>{
                e.preventDefault();
                let returnData = chkYoutubeUrl(songUrl.value);
                if(!returnData){
                }else{
                    
                    socket.emit('addSong',{video_id: returnData , user: localStorage.getItem('name')});
                    addSongBg.style.display = 'none';
                }
            })

            function chkYoutubeUrl(_data){
                let text = _data , returnData ,startNum;
                if (!text) {return;}
                if (text.indexOf('youtube') == -1){return;}
                    startNum = text.indexOf('v=');
                if(startNum == -1 ){return;}
                    returnData = text.substr( startNum + 2 , 11 );
                if(returnData.length !== 11 ){return;}
                return returnData;
            }

            function onYouTubePlayerAPIReady() {
                videoId = videoList[0].video_id;
                user.innerHTML = '點播者:'+videoList[0].user;

                videoList.splice(0, 1);

                player = new YT.Player('player', {
                    height  : '0',
                    width   : '0',
                    videoId : videoId,
                    events  : {
                                'onReady'       : onPlayerReady,
                                'onStateChange' : onPlayerStateChange,
                                'onError'       : onError
                            }
                });
                console.log(player);
            }
            function nextSong(){
                if(videoList.length === 0){
                    alert('end');
                    return;
                }
                videoId = videoList[0].video_id;
                user.innerHTML = '點播者:'+videoList[0].user;
                videoList.splice(0, 1);
                player.loadVideoById(videoId);
                player.playVideo();
            }

            function onError(event){
                console.log(event);
                nextSong();
            }

            function onPlayerReady(event) {
                event.target.playVideo();
                volume.value = event.target.getVolume();
            }

            function onPlayerStateChange(event) {
                switch(event.data){
                    case -1:
                        player.playVideo();
                        break;
                    case 0://結束
                        nextSong();
                        break;
                    case 1:
                        videoData = event.target.getVideoData();
                        bg.style.backgroundImage    = 'url(https://i.ytimg.com/vi/'+videoData.video_id+'/hqdefault.jpg)';
                        img.style.backgroundImage   = 'url(https://i.ytimg.com/vi/'+videoData.video_id+'/hqdefault.jpg)';
                        title.innerHTML             = videoData.title;
                        author.innerHTML            = videoData.author;
                        break;
                    case 3:
                        break;
                    default:
                        break;
                }
            }

        if(localStorage.getItem('name') === null){
            let person = prompt("请输入您的名字：");
            if (person == null || person == "") {
                youName();
            } else {
                localStorage.setItem("name", person );
                socket.emit('connectNum',localStorage.getItem('name'));
            }
        }else{
            socket.emit('connectNum',localStorage.getItem('name'));
        }

        send.addEventListener('click', () => {
            Send();
        });
        socket.on('connectNum',data =>{
            connectNum.innerHTML = data;
        })

        socket.on('videoList',data =>{
            for(let item = 0; item < data.length;item++){
                videoList.push(data[item]);
            }
        })

        socket.on('message', data => {
            let dt = new Date(data.time);
            let htmlData =  '<div class="chat">'+
                            '<div class="group">'+
                            '<div class="name">'+data.name+'：</div>'+
                            '<div class="msg">'+data.msg+'</div>'+
                            '</div>'+
                            '<div class="time">'+
                                dt.getFullYear()+'/'+
                                (dt.getMonth()+1)+'/'+
                                dt.getDate()+' '+
                                dt.getHours()+':'+
                                dt.getMinutes()+':'+
                                dt.getSeconds()+
                            '</div>'+
                            '</div>';
            chats.innerHTML += htmlData;
            chats.scrollTo(0, chats.scrollHeight);
        })

        function Send() {
            let msg     = document.getElementById('msg').value,
                data;
            if (!msg) {
                return;
            }
            data = {name: localStorage.getItem('name'),msg: msg};
            socket.emit('message', data);
            document.getElementById('msg').value = '';
        }

        </script>
    </body>
</html>